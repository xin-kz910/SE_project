{% set s = (project.status|string)|trim|lower|replace(' ', '_') %}
{% extends "base.html" %}
{% block title %}{{ project.title }}{% endblock %}

{% block content %}

{# ============================
      PDF éŒ¯èª¤è¨Šæ¯
============================ #}
{% if request.query_params.get('pdf') == '0' %}
<div id="pdf-error" style="background:#ffe6e6;color:#c00;padding:12px 18px;border:1px solid #ffb3b3;border-radius:6px;font-weight:bold;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    âš  è«‹ä¸Šå‚³ PDF æª”æ¡ˆï¼ˆ.pdfï¼‰
</div>

<script>
  setTimeout(() => {
      const el = document.getElementById('pdf-error');
      if (el) {
          el.style.transition = "opacity 0.6s ease";
          el.style.opacity = "0";
          setTimeout(() => el.remove(), 600);
      }
  }, 3000);
</script>
{% endif %}

{# ============================
      æŠ•æ¨™æˆåŠŸæç¤º
============================ #}
{% if request.query_params.get('bid_uploaded') == '1' %}
<div id="bid-toast"
     style="background:#d4f9d4;color:#0b7a0b;padding:12px 18px;border:1px solid #8bd98b;border-radius:6px;font-weight:bold;margin-bottom:16px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.15);">
    ğŸŸ¢ ææ¡ˆè¨ˆç•«æ›¸èˆ‡å ±åƒ¹å·²æˆåŠŸé€å‡ºï¼
</div>

<script>
setTimeout(() => {
    const el = document.getElementById('bid-toast');
    if (el) {
        el.style.transition = "opacity 0.6s ease";
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 600);
    }
}, 3000);
</script>
{% endif %}

<div class="detail-header">
  <div>
    <h2 style="margin:0">{{ project.title }}</h2>

    {# ç‹€æ…‹å°ç…§è¡¨ #}
    {% set s = (project.status|string)|lower|trim %}
    {% set status_map = {
      'open':        ['æŠ•æ”¾ä¸­',   'blue'],
      'in_progress': ['é€²è¡Œä¸­',   'yellow'],
      'reopened':    ['è¢«é€€ä»¶',   'red'],
      'closed':      ['å·²çµæ¡ˆ',   'green']
    } %}
    {% set st = status_map.get(s, ['æœªçŸ¥', 'gray']) %}
    {% set is_open = (s == 'open') %}
    {% set is_prog = (s == 'in_progress') %}
    {% set is_reopened = (s == 'reopened') %}
    {% set is_closed = (s == 'closed') %}

    <div class="meta">
      å§”è¨—äººï¼š{{ project.client_name }}
      ï½œ ç‹€æ…‹ï¼š<span class="badge {{ st[1] }}">{{ st[0] }}</span>
      ï½œ å»ºç«‹ï¼š{{ project.created_at }}
      {% if project.budget is not none %}
        ï½œ <span class="budget-pill">ğŸ’° é ç®—ï¼š{{ project.budget }} å…ƒ</span>
      {% endif %}
      {% if project.deadline %}
        ï½œ æˆªæ­¢ï¼š{{ project.deadline }}
      {% endif %}
    </div>
  </div>

  {% if user and user.role == 'client' and user.id == project.client_id and is_open %}
    <div class="form-actions">
      <a href="/projects/{{ project.id }}/edit" class="btn">ç·¨è¼¯</a>
      <form action="/projects/{{ project.id }}/delete" method="post"
            onsubmit="return confirm('ç¢ºå®šåˆªé™¤é€™å€‹å°ˆæ¡ˆå—ï¼Ÿ');"
            style="display:inline-block">
        <button type="submit" class="btn btn-danger">åˆªé™¤</button>
      </form>
    </div>
  {% endif %}
</div>

<div class="detail-grid{% if not user %} one-col{% endif %}">
  <section class="panel">
    <h3>å°ˆæ¡ˆæè¿°</h3>
    <p style="white-space:pre-wrap">{{ project.description }}</p>

    {% if project.budget is not none %}
      <p class="meta"><b>é ç®—ï¼š</b>{{ project.budget }} å…ƒ</p>
    {% else %}
      <p class="meta"><b>é ç®—ï¼š</b>â€”</p>
    {% endif %}

    {# =============================
          æ¥æ¡ˆè€…æŠ•æ¨™å€
    ============================== #}
    {% if user and user.role == 'freelancer' %}
        {% if project.deadline and project.deadline < now %}
            <hr><p style="color:#c00;font-weight:bold;">âš  æŠ•æ¨™å·²æˆªæ­¢</p>

        {% elif not bids %}
            <hr><h3>æˆ‘è¦å ±åƒ¹</h3>

            <form action="/bids/{{ project.id }}" method="post" enctype="multipart/form-data" class="form">
              <div class="field">
                <label>é‡‘é¡ï¼ˆNTDï¼‰</label>
                <input type="number" name="price" min="0" step="100" required>
              </div>
              <div class="field">
                <label>ç•™è¨€</label>
                <textarea name="message" rows="3"></textarea>
              </div>
              <div class="field">
                <label>ä¸Šå‚³ææ¡ˆè¨ˆç•«æ›¸ï¼ˆPDFï¼‰</label>
                <input type="file" name="proposal_file" accept="application/pdf" required>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">é€å‡ºå ±åƒ¹</button>
              </div>
            </form>
        {% endif %}
    {% endif %}

    {# =============================
          ä¸­æ¨™è€…ä¸Šå‚³çµæ¡ˆæª”æ¡ˆ
    ============================== #}
    {% if user and user.role == 'freelancer' and user.id == project.awarded_freelancer_id %}
      {% set my_uploads = (deliveries | selectattr('freelancer','equalto', user.username) | list) %}
      <hr>

      {% if is_prog or is_reopened %}
        {% if my_uploads|length > 0 and not is_reopened %}
          <div class="form-alert" style="color:gray;">âœ… ä½ å·²ä¸Šå‚³çµæ¡ˆæª”æ¡ˆï¼Œè«‹ç­‰å¾…å§”è¨—äººå¯©æ ¸ã€‚</div>
        {% else %}
          <h3>ä¸Šå‚³çµæ¡ˆæª”æ¡ˆ{% if is_reopened %}ï¼ˆé€€ä»¶å¾Œé‡æ–°ä¸Šå‚³ï¼‰{% endif %}</h3>

          {% if is_reopened %}
            <p class="form-error">âš ï¸ å°ˆæ¡ˆå·²è¢«é€€ä»¶ï¼Œè«‹é‡æ–°ä¸Šå‚³ä¿®æ­£ç‰ˆï¼</p>
          {% endif %}

          <form action="/deliveries/{{ project.id }}" method="post" enctype="multipart/form-data" class="form">
            <div class="field"><label>èªªæ˜</label><textarea name="note" rows="3"></textarea></div>
            <div class="field"><input type="file" name="file" required></div>
            <div class="form-actions"><button type="submit" class="btn btn-primary">ä¸Šå‚³æª”æ¡ˆ</button></div>
          </form>
        {% endif %}
      {% elif is_closed %}
        <p style="color:green;">âœ… å°ˆæ¡ˆå·²çµæ¡ˆï¼Œæ„Ÿè¬ä½ çš„åˆä½œï¼</p>
      {% endif %}
    {% endif %}
  </section>

  {# =============================
          å³å´å€å¡Šï¼ˆæ ¹æ“šç™»å…¥è€…è§’è‰²é¡¯ç¤ºï¼‰
    ============================== #}
  {% if user %}
  <aside class="panel">

    {# ======== CLIENT å€ ======== #}
    {% if user.role == 'client' %}

      <h3>æ”¶åˆ°çš„å ±åƒ¹</h3>
      {% if bids %}
        <ul>
          {% for b in bids %}
            <li style="margin-bottom:12px">
              <b>{{ b.freelancer }}</b> å ± <b>{{ b.price }}</b> å…ƒ
              <small>ï¼ˆ{{ b.created_at }}ï¼‰</small><br>
              <em>{{ b.message }}</em>

              {% if b.proposal_filename %}
              <div style="margin-top:6px;">
                ğŸ“„ <a href="/www/uploads/{{ b.proposal_filename }}"
                      download="{{ b.proposal_original_name }}"
                      target="_blank"
                      style="color:#0b79d0;font-weight:bold;">
                      {{ b.proposal_original_name }}
                    </a>
              </div>
              {% endif %}

              {# ===== æ¥å—å ±åƒ¹è¦å‰‡ ===== #}
              {% if project.awarded_bid_id == b.id %}
                <span class="badge green">â˜… å·²æ¥å—ï¼ˆå·²å§”è¨—ï¼‰</span>

              {% elif project.awarded_bid_id %}
                <span class="badge gray">å·²é¸å®šå…¶ä»–ææ¡ˆ</span>

              {% elif project.deadline and now < project.deadline %}
                <span class="badge yellow">â³ æˆªæ­¢å¾Œæ‰èƒ½é¸æ“‡</span>

              {% elif is_open %}
                <form action="/projects/{{ project.id }}/award/{{ b.id }}" method="post" style="margin-top:8px;">
                  <button class="btn btn-success btn-sm">æ¥å—å ±åƒ¹ï¼ˆå§”è¨—ï¼‰</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="help">ç›®å‰å°šç„¡å ±åƒ¹ã€‚</p>
      {% endif %}

      {# é‡æ–°é–‹æ”¾æŠ•æ¨™ #}
	  {% if is_open and project.deadline and project.deadline < now and user.id == project.client_id %}
		  <form action="/projects/{{ project.id }}/reopen_bids" method="post" style="margin:8px 0;">
		  	  <button type="submit" class="btn btn-primary">ğŸ”„ é‡æ–°é–‹æ”¾æŠ•æ¨™ï¼ˆå»¶é•· 7 å¤©ï¼‰</button>
		  </form>
	  {% endif %}

      <hr>

	  <h3>çµæ¡ˆæª”æ¡ˆï¼ˆæ­·å²ç‰ˆæœ¬ï¼‰</h3>

	  {% if deliveries and deliveries|length %}
	    <ul>
		  {% for d in deliveries %}
		    {% set version = loop.index %}
		    <li style="margin-bottom:8px">

			  <b>ç‰ˆæœ¬ v{{ version }}</b><br>

			  <a href="/www/uploads/{{ d.filename }}" target="_blank">
				  {{ d.filename.split('_', 1)[1] }}
			  </a>

			  <small>
			    ï¼ˆä¸Šå‚³è€…ï¼š{{ d.freelancer }}ï½œæ™‚é–“ï¼š{{ d.created_at }}ï¼‰
			  </small>
			  <br>

			  {% if d.note %}
			    <em>{{ d.note }}</em>
			  {% endif %}

		    </li>
		  {% endfor %}
	    </ul>
	  {% else %}
	    <p class="help">ç›®å‰å°šç„¡çµæ¡ˆæª”æ¡ˆã€‚</p>
	  {% endif %}

	  {% if user.id == project.client_id %}
	    {% if is_prog %}
		  {% if deliveries and deliveries|length %}
		    <form action="/projects/{{ project.id }}/close" method="post" style="display:inline-block;">
			  <button class="btn btn-success">âœ… ç¢ºèªçµæ¡ˆ</button>
		    </form>
		    <form action="/projects/{{ project.id }}/reject" method="post" style="display:inline-block;margin-left:8px;">
			  <button class="btn btn-danger">ğŸš« é€€ä»¶</button>
		    </form>
		  {% else %}
		    <p class="help">âš ï¸ å°šç„¡ä¸Šå‚³æª”æ¡ˆï¼Œç„¡æ³•çµæ¡ˆæˆ–é€€ä»¶ã€‚</p>
		  {% endif %}
	    {% elif is_closed %}
		  <p style="color:green;"><b>å°ˆæ¡ˆå·²çµæ¡ˆ</b></p>
	    {% elif is_reopened %}
		  <p style="color:#c00;"><b>å·²é€€ä»¶ï¼Œç­‰å¾…ä¸Šå‚³æ–°ç‰ˆæœ¬</b></p>
	    {% endif %}
	  {% endif %}



    {# ======== FREELANCER å€ ======== #}
    {% elif user.role == 'freelancer' %}

      <h3>æˆ‘æäº¤çš„å ±åƒ¹</h3>
      {% if bids %}
        {% for b in bids %}
          {% if b.freelancer == user.username %}
            <p><b>é‡‘é¡ï¼š</b>{{ b.price }} å…ƒ</p>
            <p><b>ç•™è¨€ï¼š</b>{{ b.message }}</p>
          {% endif %}
        {% endfor %}
      {% else %}
        <p class="help">å°šæœªæäº¤å ±åƒ¹ã€‚</p>
      {% endif %}

      <hr>

      <h3>æˆ‘ä¸Šå‚³çš„çµæ¡ˆæª”æ¡ˆ</h3>
      {% set my_uploads = (deliveries | selectattr('freelancer','equalto', user.username) | list) %}
      {% if my_uploads %}
        <ul>
          {% for d in my_uploads %}
            <li>
              <a href="/www/uploads/{{ d.filename }}" target="_blank">{{ d.filename }}</a>
              <small>ï¼ˆ{{ d.created_at }}ï¼‰</small><br>
              <em>{{ d.note }}</em>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="help">å°šæœªä¸Šå‚³çµæ¡ˆæª”æ¡ˆã€‚</p>
      {% endif %}

    {% endif %}
  </aside>
  {% endif %}
</div>

{# è¿”å›åˆ—è¡¨æŒ‰éˆ• #}
{% if is_open %}
  {% set back_url = '/?tab=open' %}
{% elif is_prog or is_reopened %}
  {% set back_url = '/?tab=progress' %}
{% elif is_closed %}
  {% set back_url = '/?tab=closed' %}
{% else %}
  {% set back_url = '/' %}
{% endif %}

<p style="margin-top:16px">
  <a href="{{ back_url }}" class="btn">â†© å›åˆ—è¡¨</a>
</p>

{% endblock %}
