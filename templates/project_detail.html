{% set s = (project.status|string)|trim|lower|replace(' ', '_') %}
{% extends "base.html" %}
{% block title %}{{ project.title }}{% endblock %}

{% block content %}
<div class="detail-header">
  <div>
    <h2 style="margin:0">{{ project.title }}</h2>

    {# ---- ç‹€æ…‹æ­£è¦åŒ– ï¼† å°ç…§è¡¨ ---- #}
    {% set s = (project.status|string)|trim|lower %}
    {% set status_map = {
      'open':        ['æŠ•æ”¾ä¸­',   'blue'],
      'in_progress': ['é€²è¡Œä¸­',   'yellow'],
      'reopened':    ['è¢«é€€ä»¶',   'red'],
      'closed':      ['å·²çµæ¡ˆ',   'green']
    } %}
    {% set st = status_map.get(s, ['æœªçŸ¥', 'gray']) %}
    {% set is_open = (s == 'open') %}
    {% set is_prog = (s == 'in_progress') %}
    {% set is_reopened = (s == 'reopened') %}
    {% set is_closed = (s == 'closed') %}

    <div class="meta">
      å§”è¨—äººï¼š{{ project.client_name }}
      ï½œ ç‹€æ…‹ï¼š<span class="badge {{ st[1] }}">{{ st[0] }}</span>
      ï½œ å»ºç«‹ï¼š{{ project.created_at }}
      {% if project.budget is not none %}
        ï½œ <span class="budget-pill">ğŸ’° é ç®—ï¼š{{ project.budget }} å…ƒ</span>
      {% endif %}
    </div>
  </div>

  {% if user and user.role == 'client' and user.id == project.client_id and is_open %}
    <div class="form-actions">
      <a href="/projects/{{ project.id }}/edit" class="btn">ç·¨è¼¯</a>
      <form action="/projects/{{ project.id }}/delete" method="post"
            onsubmit="return confirm('ç¢ºå®šåˆªé™¤é€™å€‹å°ˆæ¡ˆå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚');"
            style="display:inline-block">
        <button type="submit" class="btn btn-danger">åˆªé™¤</button>
      </form>
    </div>
  {% endif %}
</div>

<div class="detail-grid{% if not user %} one-col{% endif %}">
  <!-- å·¦ï¼šå…§å®¹ & ä¸Šå‚³/å¯©æ ¸æµç¨‹ -->
  <section class="panel">
    <h3>å°ˆæ¡ˆæè¿°</h3>
    <p style="white-space:pre-wrap">{{ project.description }}</p>

    {% if project.budget is not none %}
      <p class="meta"><b>é ç®—ï¼š</b>{{ project.budget }} å…ƒ</p>
    {% else %}
      <p class="meta"><b>é ç®—ï¼š</b>â€”</p>
    {% endif %}

    {# æ¥æ¡ˆè€…å°šæœªæŠ•æ¨™ï¼šé¡¯ç¤ºæˆ‘è¦å ±åƒ¹ #}
    {% if user and user.role == 'freelancer' and not bids %}
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />
      <h3>æˆ‘è¦å ±åƒ¹</h3>
      <form action="/bids/{{ project.id }}" method="post" class="form">
        <div class="field">
          <label>é‡‘é¡ï¼ˆNTDï¼‰</label>
          <input type="number" name="price" min="0" step="100" required>
        </div>
        <div class="field">
          <label>ç•™è¨€</label>
          <textarea name="message" rows="3" placeholder="å¯ç°¡è¿°å·¥æ™‚/äº¤ä»˜ç‰©/æ³¨æ„äº‹é …"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">é€å‡ºå ±åƒ¹</button>
        </div>
      </form>
    {% endif %}

    {# æ¥æ¡ˆè€…æœ¬äººï¼ˆä¸­æ¨™è€…ï¼‰å¯ä¸Šå‚³ï¼šin_progress æˆ– reopened #}
    {% if user and user.role == 'freelancer' and user.id == project.awarded_freelancer_id %}
    {% set my_uploads = (deliveries | selectattr('freelancer','equalto', user.username) | list) %}
    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />

    {% if is_prog or is_reopened %}
      {% if my_uploads|length > 0 and not is_reopened %}
        <div class="form-alert" style="color:gray; margin-bottom:8px;">
          âœ… ä½ å·²ä¸Šå‚³çµæ¡ˆæª”æ¡ˆï¼Œè«‹ç­‰å¾…å§”è¨—äººå¯©æ ¸ã€‚
        </div>
      {% else %}
        <h3>ä¸Šå‚³çµæ¡ˆæª”æ¡ˆ{% if is_reopened %}ï¼ˆé€€ä»¶å¾Œé‡æ–°ä¸Šå‚³ï¼‰{% endif %}</h3>
        {% if is_reopened %}
          <p class="form-error">âš ï¸ å°ˆæ¡ˆå·²è¢«é€€ä»¶ï¼Œè«‹é‡æ–°ä¸Šå‚³ä¿®æ­£ç‰ˆï¼</p>
        {% endif %}

        {% if request.query_params.get('filedup') == '1' %}
          <div class="form-alert error" style="margin-bottom:8px;">
            ä½ å·²ä¸Šå‚³éæª”æ¡ˆã€‚è‹¥è¦é‡å‚³ï¼Œè«‹å§”è¨—äººæŒ‰ã€Œé€€ä»¶ã€å¾Œå†ä¸Šå‚³æ–°ç‰ˆã€‚
          </div>
        {% endif %}

        <form action="/deliveries/{{ project.id }}" method="post" enctype="multipart/form-data" class="form">
          <div class="field"><label>èªªæ˜</label><textarea name="note" rows="3"></textarea></div>
          <div class="field"><input type="file" name="file" required></div>
          <div class="form-actions"><button type="submit" class="btn btn-primary">ä¸Šå‚³æª”æ¡ˆ</button></div>
        </form>
      {% endif %}

    {% elif is_closed %}
      <p style="color:green;">âœ… å°ˆæ¡ˆå·²çµæ¡ˆï¼Œæ„Ÿè¬ä½ çš„åˆä½œï¼</p>
    {% endif %}

  {% endif %}

  </section>

  {% if user %}
  <!-- å³ï¼šå ±åƒ¹èˆ‡çµæ¡ˆå€ -->
  <aside class="panel">
    {% if user and user.role == 'client' %}
      <h3>æ”¶åˆ°çš„å ±åƒ¹</h3>
      {% if bids and bids|length %}
        <ul>
          {% for b in bids %}
            <li style="margin-bottom:12px">
              <b>{{ b.freelancer }}</b> å ± <b>{{ b.price }}</b> å…ƒ
              <small>ï¼ˆ{{ b.created_at }}ï¼‰</small><br>
              <em>{{ b.message }}</em>

              {% if is_open %}
                <div style="margin-top:8px;">
                  <form action="/projects/{{ project.id }}/award/{{ b.id }}" method="post">
                    <button type="submit" class="btn btn-success btn-sm">æ¥å—å ±åƒ¹</button>
                  </form>
                </div>
              {% elif project.awarded_bid_id == b.id %}
                <span class="badge green" style="margin-top:8px;display:inline-block;">â˜… å·²æ¥å—</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">ç›®å‰å°šç„¡å ±åƒ¹ã€‚</div>
      {% endif %}

      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />
      <h3>çµæ¡ˆæª”æ¡ˆ</h3>
      {% if deliveries and deliveries|length %}
        <ul>
          {% for d in deliveries %}
            <li style="margin-bottom:6px">
              <a href="/www/uploads/{{ d.filename }}" target="_blank">{{ d.filename }}</a>
              <small>ï¼ˆä¸Šå‚³è€…ï¼š{{ d.freelancer }}ï¼Œæ™‚é–“ï¼š{{ d.created_at }}ï¼‰</small><br>
              <em>{{ d.note }}</em>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">ç›®å‰å°šç„¡çµæ¡ˆæª”æ¡ˆã€‚</div>
      {% endif %}

      {% if user.id == project.client_id %}
        {% if is_prog %}
          {% if deliveries and deliveries|length %}
            <form action="/projects/{{ project.id }}/close" method="post" style="display:inline-block">
              <button type="submit" class="btn btn-success">âœ… ç¢ºèªçµæ¡ˆ</button>
            </form>
            <form action="/projects/{{ project.id }}/reject" method="post" style="display:inline-block;margin-left:8px">
              <button type="submit" class="btn btn-danger">ğŸš« é€€ä»¶</button>
            </form>
          {% else %}
            <p class="help">âš ï¸ å°šç„¡ä¸Šå‚³æª”æ¡ˆï¼Œç„¡æ³•çµæ¡ˆæˆ–é€€ä»¶ã€‚</p>
          {% endif %}
        {% elif is_closed %}
          <p style="color:green;"><b>å°ˆæ¡ˆå·²çµæ¡ˆ âœ…</b></p>
        {% elif is_reopened %}
          <p style="color:#c00;"><b>å·²é€€ä»¶ï¼Œç­‰å¾…æ¥æ¡ˆäººé‡æ–°ä¸Šå‚³</b></p>
        {% endif %}
      {% endif %}
    {% elif user and user.role == 'freelancer' %}
      <h3>æˆ‘æäº¤çš„å ±åƒ¹</h3>
      {% if bids and bids|length %}
        {% for b in bids %}
          {% if b.freelancer == user.username %}
            <p><b>é‡‘é¡ï¼š</b>{{ b.price }} å…ƒ</p>
            <p><b>ç•™è¨€ï¼š</b>{{ b.message }}</p>
          {% endif %}
        {% endfor %}
      {% else %}
        <p class="help">å°šæœªæäº¤å ±åƒ¹ã€‚</p>
      {% endif %}

      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />
      <h3>æˆ‘ä¸Šå‚³çš„çµæ¡ˆæª”æ¡ˆ</h3>
      {% set my_uploads = (deliveries | selectattr('freelancer','equalto', user.username) | list) %}
      {% if my_uploads|length %}
        <ul>
          {% for d in my_uploads %}
            <li>
              <a href="/www/uploads/{{ d.filename }}" target="_blank">{{ d.filename }}</a>
              <small>ï¼ˆ{{ d.created_at }}ï¼‰</small><br>
              <em>{{ d.note }}</em>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="help">å°šæœªä¸Šå‚³çµæ¡ˆæª”æ¡ˆã€‚</p>
      {% endif %}
    {% endif %}
  </aside>
  {% endif %}
</div>


{% if is_open %}
  {% set back_url = '/?tab=open' %}
{% elif is_prog or is_reopened %}
  {% set back_url = '/?tab=progress' %}
{% elif is_closed %}
  {% set back_url = '/?tab=closed' %}
{% else %}
  {% set back_url = '/' %}
{% endif %}
<p style="margin-top:16px">
  <a href="{{ back_url }}" class="btn">â†© å›åˆ—è¡¨</a>
</p>
{% endblock %}
